# Выбор и настройка мониторинга в системе

## Мотивация

Внедрение мониторинга позволит:

- Быстро реагировать на изменения и принимать правильные решения
- Собирать и анализировать данные о работе систем, это помогает прогнозировать будущие изменения и планировать развитие компании
- Оптимизировать использование ресурсов, а также следить за их изменениями
- Определить узкие места в системе
- Следить за потерями бизнеса как в рамках B2C сегмента, так и в B2B, в контексте заказов
- Настроить систему алертинга, которая позволит быстрее реагировать на критические изменения в системе

### Выбор подхода к мониторингу

1. Shop API, CRM API, MES API - подход RED (Rate, Errors, Duration), подходит для сервисов, обрабатывающих запросы
2. S3, БД - подход USE (Utilization, Saturation, Errors), оптимален для отслеживания метрик использования ресурсов, в дальнейшем позволит понять тенденцию роста ресурсов
3. CRM API, MES API - дообоготить подходом USE, так как в нем реализована не только API составляющая, но и консюмер
4. CRM API - дообоготить подходом "Четыре золотых сигнала", так как позволит следить за метриками статусов заказов

### Метрики

#### RabbitMQ

- Number of `dead-letter-exchange` letters in RabbitMQ - обнаружение потерянных заказов, метки - queueName, messageType, source
- Number of message in flight in RabbitMQ - контроль загруженности очередей, метки - queueName, messageType, source

#### API-s

- Number of requests (RPS) - мониторинг нагрузки на систему, метки - service, endpoint, method
- CPU - контроль утилизации центрального процессора, метки - service, instanceId
- Memory Utilisation - контроль утилизации памяти и слежка за OOM, метки - service, instanceId
- Response time (latency) - контроль за производительностью ручек, метки - service, endpoint, percentile (p50, p75, p95, p99), method
- HTTP статус коды - мониторинг ошибок ручек, метки - service, endpoint, statusCode, method
- Network - контроль пропускной способности сети, метки - service

#### DB-s

- Memory Utilisation - контроль утилизации памяти, метки - db, instanceId
- Number of connections - контроль за количеством соединений в БД, метки - db, instanceId
- Size - контроль за размером данных, метки - db
- v

#### S3

- Size - контроль за размером данных, метки - bucket

### План действий

1. Развернуть Prometheus Server по модели Pull, зарегистрировать сервисы и настроить частоту сбора метрик с сервисов
2. Развернуть Grafana для визуализации и подключить Prometheus как источник
3. Установить Alertmanager для оповещений
4. Добавить сбор метрик на все сервисы (развернуть параллельно с приложением сервер, который будет отдавать метрики)
5. Добавить сбор метрик с RabbitMQ
6. Настроить пороговые значения для алертинга
