# Планирование: анализ, идентификация проблем и поиск решений

## Анализ проблемных мест

### Архитектурные

- Проблемы с маштабированием: по 1 инстансу в каждом приложении, а также на самой БД, как следствие - отсутствие возможности горизонтального масштабирования
- Проблема с обработкой анализа стоимости, исходя из предыдущего пункта можно сделать вывод, что подсчет выполняет последовательно и из за чего могут возникать проблемы со временем обработки заказа, тут также, исходя из схемы, видно, что, чтобы пользователь смог рассчитать стоимость, он должен пройти через продажника, что может накладывать некоторую ненужную работу на них
- Проблема с потерей заказов, может случиться ситуация, в которой заказ может не дойти до обработки, нет систем отслеживания потерянных заказов
- Проблема производительности MES API, так как он выполняет как функцию API, так и функцию консюмера - это может привести к проблемам спрогрузкой данных на дашборд MES
- Возможно неоптимальная работа с данными в БД MES
- Отсутствие мониторингов - здесь можно было бы просматривать среднее время нахождения заказа в том или ином состоянии, аналогично и с расчетом через MES
- Отсутствие трейсинга, использование инструментов трейсинга (например, Jaeger, Zipkin) для отслеживания пути выполнения запросов через микросервисы, помогло бы выявить проблемные места в архитектуре системы
- Отсутствие более детального логирования, например:
  - Логирование запросов (ведение подробных логов всех входящих и исходящих запросов к системе)
  - Логирование ошибок (логирование всех возникающих ошибок и исключений с указанием времени и места их возникновения)
  - Логирование состояний заказов (логирование изменений состояния заказов на каждом этапе обработки)
- Отсутствие части метрик мониторинга состояния системы, например, можно внедрить следующие метрики:
  - Время обработки заказа (среднее время, затраченное на обработку заказа от момента его поступления до завершения)
  - Количество потерянных заказов (частота и количество заказов, которые не были обработаны или потерялись в системе)
  - Среднее время нахождения заказа в состоянии (время, которое заказ проводит в каждом из возможных состояний)
- Отсутствие разделения API на внутреннее и внешнее (использование API Gateway для управления доступом и ограничения количества запросов от внешних пользователей)
- Совместное использование 1 БД онлайн магазином и CRM системой, что пагубно влияет на безопасность данных, производительность самой БД, также возможны конфликты данных (возможные несоответствия и дублирование данных между магазином и CRM) и сложность управления (усложнение управления и поддержки данных при необходимости синхронизации изменений между системами)
- Отсутствие параллельного подсчета стоимости заказов, как следствие долгая обработка 1 заказа. Для решения данной проблемы можно оптимизировать алгоритм подсчета, либо распараллелить вычисления на 1 машинке, либо распараллелить за счет горизонтального масштабирования или использовать оба подхода, также стоит не забывать кэшировать результаты расчета, чтобы не производить лишних перерасчётов одних и тех же заказов

### Процессные

- Долгий TTM из за ручного тестирования и как следствие блокировка всего релиза из за критичных багов
- Деплой в дев среду после мержа
- Распределение заказов между операторами, как следствие возникает ситуация, при которой оператор может доминировать над другими, за счет своей скорости обработки заказов

## Необходимые инициативы

### Архитектурные

- Добавление возможности горизонтального масштабирования для инстансов приложения, а также возможности автоматического скаллирования инстансов
- Добавить БД реплик, если данных в БД много разбить на шарды, так мы снизим нагрузку на 2 инстанс БД и распараллелим нагрузку на чтение из БД
- Добавить кэширование на часто запрашиваемые данные системы, что позволит нам ускорить ответ от сервера
- Добавить возможность отправки анализа стоимости изделия пользователя на сайте напрямую в очередь RebbitMQ, дабы снизить нагрузку на продажников
- Оптимизация очереди RebbitMQ за счет распараллеливания потоков в нем
- Добавить возможность отслеживать потерянные заказы
- Оптимизация БД MES, если таковая требуется
- Добавить систему мониторинга, трейсинга и логирования
- Добавить систему алертов на критически важные элементы системы

### Процессные

- Улучшения процесса тестирования, за счет прогона автотестов на релиз
- Добавление возможности выкатки в dev окружение под веткой без мержа
- Добавить возможность управления тестовыми фичами через feature toggles
- Оптимальное распределение между операторами

## Целевая архитектура через полгода

- Полная наблюдаемость за процессами системы - мониторинги, трейсы и логирование
- Алертинг на критически важные алементы системы
- Возможность горизонтального масштабирования, а также возможность автоскаллирования
- Оптимизированные схемы БД MES
- БД MES поделена на реплики (возможно не только она, если есть проблемы с клиентской БД, то ее также нужно оптимизировать и поделить на реплики)
- Возможность поиска и определения потерянных заказов
- Улучшение производительности при подсчете стоимости заказа

---

### Топ-3 инициативы на полгода

1. **Полная наблюдаемость за процессами системы (мониторинги, трейсы и логирование)**:
   - **Цель**: Обеспечить возможность наблюдения за состоянием систем в реальном времени, что упростит процесс отладки ошибок и позволит быстро находить их источники с помощью трейсов
   - **Задачи**:
     1. Внедрение инструментов мониторинга для отслеживания ключевых метрик системы
     2. Настройка логирования всех важных событий и ошибок
     3. Реализация трейсинга для отслеживания потоков выполнения и взаимодействия между сервисами
     4. Создание системы алертинга на основе метрик для оповещения о критических изменениях
2. **Горизонтальное масштабирование**:
   - **Цель**: Оптимизировать нагрузку на приложения и снизить время отклика системы, что позволит справляться с линейно растущей нагрузкой
   - **Задачи**:
     1. Оценка текущей нагрузки на систему и определение узких мест
     2. Добавление дополнительных серверов или узлов для распределения нагрузки
     3. Настройка репликации базы данных для обеспечения её доступности и отказоустойчивости
     4. Мониторинг и оптимизация производительности системы после внедрения изменений
3. **Улучшения механизмов работы с заказами**:
   - **Цель**: Повысить надежность и устойчивость работы с заказами, что особенно важно для B2B сегмента, где потеря заказов может привести к значительным проблемам
   - **Задачи**:
     1. Анализ текущих процессов обработки заказов и выявление узких мест
     2. Внедрение дополнительных проверок и механизмов подтверждения заказов
     3. Разработка и тестирование резервных и восстановительных процедур для обработки заказов
